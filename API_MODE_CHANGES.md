# API 模式优化说明

## 修改内容

### 问题描述
之前的代码在处理评论数大于 1500 的视频时，虽然会尝试使用 API 模式，但如果 API 失败会回退到浏览器滚动模式，导致：
1. 需要长时间滚动页面
2. 滚动效果不佳（位置一直是 0px）
3. 获取效率低下

### 解决方案

**修改了 `get_video_comments_api` 方法的错误处理逻辑：**

#### 修改前：
```python
except ImportError:
    log("无法导入 API 模块，回退到浏览器模式", "WARNING")
    return self.get_video_comments(aweme_id, expected_count)  # 回退到滚动模式
except Exception as e:
    log(f"API 获取异常: {e}，回退到浏览器模式", "WARNING")
    return self.get_video_comments(aweme_id, expected_count)  # 回退到滚动模式
```

#### 修改后：
```python
except ImportError as e:
    log(f"无法导入 API 模块: {e}，跳过该视频评论获取", "ERROR")
    # 不再回退到滚动模式，直接返回空列表
except Exception as e:
    log(f"API 获取异常: {e}，跳过该视频评论获取", "ERROR")
    # 不再回退到滚动模式，直接返回空列表
```

### 修改的关键点

1. **移除回退逻辑** - 不再调用 `self.get_video_comments()` 回退到浏览器滚动模式
2. **直接返回结果** - API 失败时返回空列表或已获取的部分评论
3. **优化日志提示** - 明确说明使用 API 模式且无需滚动

### 工作流程

#### 评论数 ≤ 1500：
- 使用浏览器滚动模式
- 获取一级和二级评论
- 完整覆盖所有评论

#### 评论数 > 1500：
- ✅ **只使用 API 模式**
- ✅ **无需打开浏览器页面**
- ✅ **无需滚动操作**
- ✅ **只获取一级评论**
- ✅ **速度快（每页 50 条，最多 200 页）**
- ❌ **如果 API 失败，直接跳过该视频**

### 优势

1. **速度更快** - API 直接请求，无需等待页面加载和滚动
2. **更稳定** - 避免浏览器滚动失效的问题
3. **资源占用少** - 不需要渲染浏览器页面
4. **逻辑清晰** - 大评论量视频专用 API，小评论量视频用滚动

### 使用示例

```bash
# 运行爬虫
uv run python crawl_mix_drission.py --mix-id 7326746646719498279 --start 10 --login-wait 60
```

当遇到评论数 > 1500 的视频时，会看到：
```
[时间] ℹ️  评论数 3501 > 1500，使用 API 快速模式（只抓一级评论）
[时间] ℹ️  使用 API 模式获取一级评论（无需滚动）...
[时间] 📊 API 第 1 页 | 已获取 50 条一级评论 | 覆盖率 1.4%
[时间] 📊 API 第 2 页 | 已获取 100 条一级评论 | 覆盖率 2.9%
...
[时间] ✅ API 获取完成，共 40 页，2000 条评论
[时间] ✅ API 模式成功获取 2000 条评论
```

### 注意事项

1. API 模式只获取一级评论，不包括二级回复
2. 如果 Cookie 失效，API 可能会失败
3. 最多获取 10,000 条评论（200页 × 50条/页）
4. API 请求间隔 0.3 秒，避免触发限流

## 修改日期
2025-11-25
